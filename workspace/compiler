#!/usr/bin/env python3
import sys
import subprocess

if len(sys.argv) < 4 or sys.argv[2] != "-o":
    print("Usage: compiler <input.py> -o <output>")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[3]

with open(input_file) as f:
    line = f.readline().strip()

# Parse x = value
if "=" in line:
    _, raw_value = line.split("=")
    raw_value = raw_value.strip()
else:
    print("Expected variable assignment.")
    sys.exit(1)

# Process value for string output
if raw_value.startswith('"') or raw_value.startswith("'"):
    value = raw_value.strip('"').strip("'") + "\\n"
elif "." in raw_value:
    value = str(float(raw_value)) + "\\n"
elif raw_value in ["True", "False"]:
    value = raw_value + "\\n"
else:
    value = str(int(raw_value)) + "\\n"

asm = f"""
    .data
str: .ascii "{value}"
len = . - str

    .text
    .global _start
_start:
    mov x0, #1
    adr x1, str
    mov x2, len
    mov x8, #64
    svc #0

    mov x0, #0
    mov x8, #93
    svc #0
"""

with open("out.s", "w") as f:
    f.write(asm)

subprocess.run(["as", "-o", "out.o", "out.s"], check=True)
subprocess.run(["ld", "out.o", "-o", output_file], check=True)

print(f"âœ… Compiled to {output_file}")
